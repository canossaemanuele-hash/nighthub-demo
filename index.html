<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>NightHub OS - Enterprise Club Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #020617; }
        
        /* UI Basics */
        .tavolo { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; user-select: none; }
        .tavolo:active { transform: scale(0.95); }
        .tavolo-prenotato { background-color: #1e293b !important; border-color: #334155 !important; color: #475569 !important; cursor: not-allowed !important; opacity: 0.6; pointer-events: none; }
        .tab-active { background-color: #eab308 !important; color: #000 !important; font-weight: 900; box-shadow: 0 4px 15px rgba(234, 179, 8, 0.3); }
        .sezione-contenuto { display: none; }
        .sezione-contenuto.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        
        /* Scanner Video Fullscreen */
        #reader video { object-fit: cover; height: 100vh !important; width: 100vw !important; }

        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #eab308; cursor: pointer; margin-top: -10px; box-shadow: 0 0 10px rgba(234,179,8,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        /* Security Colors */
        .status-ok { background-color: #22c55e; color: black; }
        .status-ko { background-color: #ef4444; color: white; }
        
        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; max-width: 400px; }
        .toast { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(234, 179, 8, 0.3); color: white; padding: 16px; rounded-2xl; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; animation: slideUp 0.3s ease-out; display: flex; align-items: center; justify-content: space-between; backdrop-filter: blur(10px); }
        .img-viewer { width: 100%; height: 100%; overflow: auto; display: flex; align-items: flex-start; justify-content: center; background: #000; }
        .img-viewer img { max-width: none; width: 250%; height: auto; padding: 20px; }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #eab308; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-100 overflow-x-hidden">

    <div id="login-screen" class="fixed inset-0 z-[3000] flex flex-col items-center justify-center p-8 bg-black/90" style="background-image: url('https://images.unsplash.com/photo-1566737236500-c8ac43014a67?auto=format&fit=crop&w=1200&q=80'); background-size: cover;">
        <div class="w-full max-w-sm glass p-10 rounded-[3rem] shadow-2xl border-yellow-500/20 text-center">
            <h1 class="text-4xl font-black italic tracking-tighter text-white mb-2">NIGHT<span class="text-yellow-500 font-black">HUB</span></h1>
            <p class="text-[9px] uppercase tracking-[0.3em] text-slate-400 mb-8 font-bold italic">Enterprise Access</p>
            <div class="space-y-4">
                <input type="text" id="user-input" placeholder="Username" class="w-full bg-slate-950/50 border border-slate-700 p-4 rounded-2xl text-sm focus:border-yellow-500 outline-none text-white italic">
                <input type="password" id="pass-input" placeholder="Password" class="w-full bg-slate-950/50 border border-slate-700 p-4 rounded-2xl text-sm focus:border-yellow-500 outline-none text-white">
                <button onclick="checkLogin()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl uppercase text-xs tracking-widest italic shadow-xl active:scale-95 transition-transform">Entra</button>
            </div>
        </div>
    </div>

    <div id="landing-page" class="hidden fixed inset-0 z-[1000] flex flex-col p-8 overflow-y-auto bg-black/90">
        <div class="flex justify-end mb-4"><button onclick="logout()" class="glass px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest text-slate-400 italic">Logout ‚úï</button></div>
        <header class="text-center py-6">
            <h1 class="text-6xl font-black italic tracking-tighter text-white">NIGHT<span class="text-yellow-500">HUB</span></h1>
        </header>
        <div class="space-y-6 max-w-md mx-auto w-full pt-6">
            <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-2 italic">Locali Live</h2>
            <div onclick="entraNelLocale('Taverna Priscilla')" class="relative cursor-pointer overflow-hidden rounded-[2.5rem] border border-yellow-500/40 bg-slate-900 shadow-2xl active:scale-95 transition-transform">
                <div class="h-44 bg-cover bg-center opacity-70" style="background-image: url('https://images.unsplash.com/photo-1574094939582-9357dedc6361?auto=format&fit=crop&w=600&q=80');"></div>
                <div class="p-6 absolute bottom-0 left-0 right-0 glass rounded-t-[2rem]">
                    <div class="flex justify-between items-center">
                        <div><h3 class="font-black text-2xl uppercase italic text-white">Taverna Priscilla</h3><p class="text-[10px] text-yellow-500 font-bold uppercase italic">Poggio Rusco (MN)</p></div>
                        <span class="bg-green-500 text-black text-[9px] font-black px-3 py-1 rounded-full">LIVE</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden min-h-screen">
        <header class="p-5 border-b border-slate-900 text-center bg-slate-950/80 backdrop-blur-md sticky top-0 z-[100] flex justify-between items-center">
            <button onclick="tornaAllaHome()" class="text-slate-500 text-[10px] font-black uppercase tracking-widest italic">‚Üê Locali</button>
            <h1 id="titolo-locale" class="text-sm font-black uppercase text-yellow-500 italic">Club</h1>
            <div class="w-10"></div>
        </header>

        <main class="p-4 max-w-md mx-auto pb-32">
            <nav id="nav-generale" class="flex justify-between mb-8 bg-slate-900 p-1 rounded-2xl border border-slate-800 text-[10px] font-black uppercase text-center shadow-2xl italic">
                <button onclick="switchView('cliente')" id="btn-cliente" class="flex-1 py-4 rounded-xl tab-active">Mappa</button>
                <button onclick="switchView('prenotazioni')" id="btn-prenotazioni" class="flex-1 py-4 rounded-xl">I miei Tavoli</button>
                <button onclick="switchView('pr')" id="btn-pr" class="hidden flex-1 py-4 rounded-xl">Area PR</button>
                <button onclick="switchView('capo')" id="btn-capo" class="hidden flex-1 py-4 rounded-xl text-red-500">Gestione</button>
            </nav>
            <nav id="nav-security" class="hidden mb-8"><div class="bg-slate-900 p-4 rounded-2xl border border-slate-800 text-center"><p class="text-xs font-black text-slate-400 uppercase tracking-widest">üõ°Ô∏è Security Gate</p></div></nav>

            <div id="sezione-cliente" class="sezione-contenuto active space-y-8">
                <button onclick="toggleMappa(true)" class="w-full py-5 bg-gradient-to-r from-yellow-600 to-yellow-500 rounded-2xl text-black text-[10px] font-black uppercase tracking-widest italic shadow-xl">üìç Piantina Interattiva HD</button>
                <div class="space-y-8">
                    
                    <section>
                        <div class="flex items-center gap-2 mb-4"><div class="h-4 w-1 bg-yellow-500 rounded-full"></div><div><h2 class="text-yellow-500 font-black uppercase text-[10px] tracking-widest italic">Gold Priv√©</h2><p id="label-price-prive" class="text-[9px] text-slate-500 font-bold uppercase">Caricamento...</p></div></div>
                        <div class="grid grid-cols-3 gap-3">
                            <div id="map-tavolo-1" onclick="selectTavolo('1', 'min_prive', 'Gold Priv√©')" class="tavolo h-16 bg-yellow-600/20 rounded-2xl flex items-center justify-center font-black text-sm border-2 border-yellow-500/50 text-yellow-500 italic">T1</div>
                            <div id="map-tavolo-2" onclick="selectTavolo('2', 'min_prive', 'Gold Priv√©')" class="tavolo h-16 bg-yellow-600/20 rounded-2xl flex items-center justify-center font-black text-sm border-2 border-yellow-500/50 text-yellow-500 italic">T2</div>
                            <div id="map-tavolo-12" onclick="selectTavolo('12', 'min_prive', 'Gold Priv√©')" class="tavolo h-16 bg-yellow-600/20 rounded-2xl flex items-center justify-center font-black text-sm border-2 border-yellow-500/50 text-yellow-500 italic">T12</div>
                        </div>
                    </section>
                    
                    <section>
                        <div class="flex items-center gap-2 mb-4"><div class="h-4 w-1 bg-green-500 rounded-full"></div><div><h2 class="text-green-500 font-black uppercase text-[10px] tracking-widest italic">Pista Centrale</h2><p id="label-price-pista" class="text-[9px] text-slate-500 font-bold uppercase">Caricamento...</p></div></div>
                        <div class="grid grid-cols-3 gap-3">
                            <div id="map-tavolo-3" onclick="selectTavolo('3', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T3</div>
                            <div id="map-tavolo-4" onclick="selectTavolo('4', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T4</div>
                            <div id="map-tavolo-5" onclick="selectTavolo('5', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T5</div>
                            <div id="map-tavolo-6" onclick="selectTavolo('6', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T6</div>
                            <div id="map-tavolo-7" onclick="selectTavolo('7', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T7</div>
                            <div id="map-tavolo-8" onclick="selectTavolo('8', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T8</div>
                            <div id="map-tavolo-9" onclick="selectTavolo('9', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T9</div>
                            <div id="map-tavolo-10" onclick="selectTavolo('10', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T10</div>
                            <div id="map-tavolo-11" onclick="selectTavolo('11', 'min_pista', 'Pista')" class="tavolo h-14 bg-green-600/10 rounded-2xl flex items-center justify-center font-black text-xs border border-green-500/30 text-green-500 italic">T11</div>
                        </div>
                    </section>
                    
                    <section>
                        <div class="flex items-center gap-2 mb-4"><div class="h-4 w-1 bg-blue-500 rounded-full"></div><div><h2 class="text-blue-500 font-black uppercase text-[10px] tracking-widest italic">Fuori Pista & Garden</h2><p id="label-price-garden" class="text-[9px] text-slate-500 font-bold uppercase">Caricamento...</p></div></div>
                        <div class="grid grid-cols-4 gap-2">
                            <div id="map-tavolo-13" onclick="selectTavolo('13', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T13</div>
                            <div id="map-tavolo-14" onclick="selectTavolo('14', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T14</div>
                            <div id="map-tavolo-15" onclick="selectTavolo('15', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T15</div>
                            <div id="map-tavolo-16" onclick="selectTavolo('16', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T16</div>
                            <div id="map-tavolo-17" onclick="selectTavolo('17', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T17</div>
                            <div id="map-tavolo-18" onclick="selectTavolo('18', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T18</div>
                            <div id="map-tavolo-19" onclick="selectTavolo('19', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T19</div>
                            <div id="map-tavolo-20" onclick="selectTavolo('20', 'min_garden', 'Garden')" class="tavolo h-12 bg-blue-600/10 rounded-xl flex items-center justify-center font-black text-[10px] border border-blue-500/30 text-blue-500 italic">T20</div>
                        </div>
                    </section>
                </div>
            </div>

            <div id="sezione-prenotazioni" class="sezione-contenuto space-y-4">
                <div id="lista-prenotazioni-attive" class="space-y-4"></div>
            </div>

            <div id="sezione-capo" class="sezione-contenuto space-y-6">
                <div class="glass p-6 rounded-[2.5rem] border-red-500/30">
                    <h3 class="text-[10px] font-black uppercase text-red-500 mb-6 italic tracking-widest text-center">‚öôÔ∏è Configurazione Serata</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center"><label class="text-[10px] uppercase text-slate-400 font-bold">Minimo Pista</label><input type="number" id="input-min-pista" class="bg-slate-900 border border-slate-700 rounded-xl p-2 w-24 text-center text-white text-xs font-black"></div>
                        <div class="flex justify-between items-center"><label class="text-[10px] uppercase text-slate-400 font-bold">Minimo Priv√®</label><input type="number" id="input-min-prive" class="bg-slate-900 border border-slate-700 rounded-xl p-2 w-24 text-center text-white text-xs font-black"></div>
                        <div class="flex justify-between items-center"><label class="text-[10px] uppercase text-slate-400 font-bold">Minimo Garden</label><input type="number" id="input-min-garden" class="bg-slate-900 border border-slate-700 rounded-xl p-2 w-24 text-center text-white text-xs font-black"></div>
                        <div class="flex justify-between items-center"><label class="text-[10px] uppercase text-slate-400 font-bold">Quota a Testa</label><input type="number" id="input-min-testa" class="bg-slate-900 border border-slate-700 rounded-xl p-2 w-24 text-center text-white text-xs font-black"></div>
                    </div>
                    <button onclick="aggiornaListino()" class="mt-6 w-full py-3 bg-red-600 text-white rounded-xl font-black uppercase text-[10px] italic shadow-lg active:scale-95 transition-transform">üíæ Salva Listino</button>
                </div>

                <div class="glass p-6 rounded-[2.5rem] border-yellow-500/30">
                    <h3 class="text-[10px] font-black uppercase text-yellow-500 text-center mb-6 italic tracking-widest">üèÜ Classifica Top PR</h3>
                    <div id="classifica-live" class="space-y-3"></div>
                </div>
                <div class="glass p-6 rounded-[2.5rem] border-slate-800">
                    <h3 class="text-[10px] font-black uppercase text-slate-500 mb-4 italic">Registro Tavoli Online</h3>
                    <div id="registro-direzione" class="space-y-3"></div>
                </div>
                <button onclick="resetTotale()" class="w-full py-4 bg-red-600/10 border-2 border-red-600 text-red-600 rounded-2xl font-black text-[10px] uppercase italic active:scale-95 transition-transform">‚ö†Ô∏è Svuota Database</button>
            </div>

            <div id="sezione-security" class="sezione-contenuto space-y-6">
                <div class="glass p-8 rounded-[3rem] border-slate-700 text-center shadow-2xl">
                    <h3 class="text-2xl font-black italic text-white mb-6">SCANNER INGRESSO</h3>
                    <button onclick="startScanner()" class="w-full py-5 bg-slate-800 text-white rounded-2xl font-black uppercase text-xs mb-6 shadow-lg">üì∑ AVVIA CAMERA FULLSCREEN</button>
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-2">Inserimento manuale</p>
                    <input id="security-scan-input" type="text" placeholder="Es. NIGHTHUB-T12-..." class="w-full bg-slate-950 border border-slate-600 p-4 rounded-xl text-white text-center font-mono text-xs mb-4 outline-none focus:border-yellow-500">
                    <button onclick="checkIn()" class="w-full py-4 bg-yellow-500 text-black rounded-xl font-black uppercase text-xs italic active:scale-95 transition-transform shadow-xl">VERIFICA</button>
                </div>
                <div id="security-result" class="hidden glass p-8 rounded-[3rem] text-center border-4"></div>
            </div>
            
            <div id="sezione-pr" class="sezione-contenuto space-y-6">
                <div class="glass p-8 rounded-[3rem] border-green-500/30 text-center shadow-2xl relative overflow-hidden">
                    <p class="text-[10px] text-green-400 uppercase font-black italic mb-2 tracking-widest">Wallet Provvigioni</p>
                    <p id="pr-wallet-total" class="text-5xl font-black text-white italic tracking-tighter mb-1">‚Ç¨ 0,00</p>
                    <button onclick="richiediAccredito()" class="mt-4 w-full py-3 bg-white text-black rounded-xl font-black uppercase text-[10px] italic">üí∏ Richiedi Accredito</button>
                </div>
                <div class="glass p-6 rounded-[2.5rem] border-slate-800">
                    <h3 class="text-[10px] font-black uppercase text-slate-500 mb-4 italic">Registro Vendite</h3>
                    <div id="lista-vendite-pr" class="space-y-3"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-pagamento" class="hidden fixed inset-0 bg-black/95 z-[2000] p-6 flex flex-col justify-center items-center">
        <div id="pay-step-calc" class="w-full max-w-sm glass p-8 rounded-[3rem] border-yellow-500/50">
            <h2 class="text-2xl font-black italic uppercase text-white mb-6 text-center">Prenota Tavolo</h2>
            
            <div class="mb-6">
                <div class="flex justify-between text-xs font-black uppercase mb-2 text-slate-400"><span>Ospiti</span><span id="label-persone" class="text-white text-lg">5 Persone</span></div>
                <input type="range" id="slider-persone" min="1" max="100" value="5" oninput="updatePriceCalculation()">
                <p id="warn-persone" class="hidden text-[9px] text-yellow-500 mt-1 font-bold italic text-center">‚ö†Ô∏è Gruppo numeroso: contattare ingresso</p>
            </div>

            <div class="mb-8">
                <div class="flex justify-between text-xs font-black uppercase mb-2 text-slate-400"><span>Budget a Testa</span><span id="label-budget" class="text-yellow-500 text-lg">‚Ç¨ 30</span></div>
                <input type="range" id="slider-budget" min="30" max="200" step="10" value="30" oninput="updatePriceCalculation()">
                <p class="text-[9px] text-slate-500 mt-2 text-center">Include credito bottiglie</p>
            </div>

            <div class="bg-slate-950 p-6 rounded-3xl mb-6 border border-slate-800 text-center">
                <p class="text-[9px] uppercase text-slate-500 font-black mb-1">Prezzo Finale</p>
                <p id="calc-total" class="text-4xl font-black text-white italic">‚Ç¨ 0</p>
                <p id="calc-note" class="text-[9px] text-green-500 mt-1 font-bold italic"></p>
            </div>

            <button onclick="goToCheckout()" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-black font-black py-5 rounded-2xl uppercase text-xs italic shadow-xl active:scale-95 transition-transform">Procedi al Pagamento</button>
            <button onclick="chiudiModalePagamento()" class="w-full text-slate-500 text-[10px] font-black uppercase mt-4 italic">Annulla</button>
        </div>

        <div id="pay-step-checkout" class="hidden w-full max-w-sm glass p-8 rounded-[3rem] border-slate-700">
            <h3 class="text-white font-black italic mb-6 text-center uppercase tracking-widest text-sm">Dati di Pagamento</h3>
            <div class="space-y-4">
                <input type="text" placeholder="Nome Cognome" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl text-white text-sm outline-none focus:border-yellow-500">
                <input type="text" placeholder="Carta di Credito" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl text-white text-sm outline-none focus:border-yellow-500">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" placeholder="MM/AA" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl text-white text-sm">
                    <input type="text" placeholder="CVV" class="w-full bg-slate-950 border border-slate-800 p-4 rounded-2xl text-white text-sm">
                </div>
                <div class="space-y-2 mt-4 pt-4 border-t border-slate-800">
                    <label class="text-[9px] font-black text-yellow-500 uppercase ml-2">Codice Promo / PR</label>
                    <input id="pr-input" oninput="checkPromo(this)" type="text" placeholder="Es. marco_pr" class="w-full bg-slate-950/50 border border-yellow-500/30 p-3 rounded-2xl text-white text-xs outline-none focus:border-yellow-500 italic">
                </div>
                <button onclick="processaPagamentoReale()" class="w-full bg-yellow-500 text-black font-black py-5 rounded-2xl uppercase text-xs italic mt-4 shadow-xl active:scale-95 transition-transform">Conferma Ordine</button>
                <button onclick="dividiConAmici()" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl text-[10px] uppercase border border-slate-700 italic active:scale-95 transition-transform mt-2">Dividi con Amici üë•</button>
                <button onclick="backToCalc()" class="w-full text-slate-500 text-[9px] font-black uppercase mt-2 italic">‚Üê Modifica Importo</button>
            </div>
        </div>

        <div id="pay-step-loading" class="hidden flex flex-col items-center justify-center p-10 glass rounded-[3rem] w-full max-w-sm"><div class="spinner mb-6"></div><p class="text-white font-black italic uppercase text-lg tracking-widest mb-2">Attendere...</p><p class="text-slate-400 text-[10px] uppercase font-bold">Autorizzazione Bancaria</p></div>
    </div>

    <div id="modal-pass" class="hidden fixed inset-0 bg-black z-[3000] flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-sm glass p-8 rounded-[3rem] border-yellow-500/50 text-center relative">
            <button onclick="chiudiPass()" class="absolute top-6 right-6 text-slate-500 font-black">X</button>
            <h2 class="text-3xl font-black italic uppercase text-white mb-2">PASS</h2>
            <p class="text-[10px] text-yellow-500 font-black uppercase tracking-widest mb-8">Accesso Garantito</p>
            <div class="bg-white p-4 rounded-2xl mb-6 mx-auto w-48 h-48 flex items-center justify-center">
                <img id="qr-image" src="" alt="QR Code" class="w-full h-full object-contain">
            </div>
            <div id="pass-details" class="space-y-2 mb-6"></div>
            <div id="pass-counter" class="bg-slate-800 p-3 rounded-xl border border-slate-600 mb-4">
                </div>
            <button onclick="showToast('Salvato in Galleria!', 'üíæ')" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-black uppercase text-[10px]">Salva Pass</button>
        </div>
    </div>

    <div id="modal-scanner" class="hidden fixed inset-0 bg-black z-[6000]">
         <button onclick="stopScanner()" class="absolute top-8 right-8 text-white bg-black/50 px-4 py-2 rounded-full font-black z-[6010]">CHIUDI X</button>
         <div id="reader" class="w-full h-full"></div>
    </div>

    <div id="modal-config" class="hidden fixed inset-0 bg-slate-950 z-[2500] p-6 overflow-y-auto">
        <div class="max-w-md mx-auto pb-20">
            <header class="flex justify-between items-center mb-6 mt-2"><h2 id="conf-nome" class="text-2xl font-black uppercase italic text-white">Tavolo</h2><button onclick="document.getElementById('modal-config').classList.add('hidden')" class="text-slate-500 font-black text-[10px] uppercase italic">Chiudi X</button></header>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="glass p-5 rounded-3xl border-green-500/30 text-center"><p class="text-[9px] uppercase text-green-500 font-black mb-1 italic">Residuo</p><p id="conf-budget" class="text-3xl font-black text-white italic">‚Ç¨ 0</p></div>
                <div class="glass p-5 rounded-3xl border-yellow-500/30 text-center"><p class="text-[9px] uppercase text-yellow-500 font-black mb-1 italic">Carrello</p><p id="conf-spesa" class="text-3xl font-black text-white italic">‚Ç¨ 0</p></div>
            </div>
            <div class="mb-8 bg-slate-900/50 p-6 rounded-3xl border border-slate-800">
                <label class="text-[10px] font-black uppercase text-slate-400 mb-3 block italic">Orario di Servizio</label>
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button onclick="setOrario('23:30', this)" class="orario-btn bg-slate-800 text-slate-400 py-2 rounded-xl text-[10px] font-black">23:30</button>
                    <button onclick="setOrario('00:00', this)" class="orario-btn bg-slate-800 text-slate-400 py-2 rounded-xl text-[10px] font-black">00:00</button>
                    <button onclick="setOrario('00:30', this)" class="orario-btn bg-slate-800 text-slate-400 py-2 rounded-xl text-[10px] font-black">00:30</button>
                    <button onclick="setOrario('01:00', this)" class="orario-btn bg-slate-800 text-slate-400 py-2 rounded-xl text-[10px] font-black">01:00</button>
                </div>
                <input type="text" id="note-ordine" placeholder="Note per i Barman..." class="w-full bg-slate-950 border border-slate-700 p-3 rounded-xl text-xs text-white outline-none focus:border-yellow-500 italic">
            </div>
            <div id="conf-lista-bottiglie" class="space-y-3 mb-8"></div>
            <button onclick="inviaOrdineFinale()" class="w-full py-5 bg-gradient-to-r from-yellow-500 to-yellow-600 text-black rounded-2xl font-black uppercase text-xs tracking-widest shadow-2xl italic border border-yellow-400">üöÄ Conferma e Invia Ordine</button>
        </div>
    </div>

    <div id="modal-direzione-dettagli" class="hidden fixed inset-0 bg-black/98 z-[5000] p-6 flex items-center justify-center">
        <div class="w-full max-w-sm glass p-8 rounded-[3rem] border-red-500/30">
            <h2 id="dir-titolo" class="text-2xl font-black uppercase italic text-white mb-2 text-center">Tavolo</h2>
            <div class="space-y-6 mt-6">
                <div class="flex justify-between text-center gap-2">
                     <div class="bg-slate-900 p-3 rounded-2xl w-1/2"><p class="text-[9px] text-slate-500 font-black uppercase">Ingressi</p><p id="dir-ingressi" class="text-xl font-black text-white">0/0</p></div>
                     <div class="bg-slate-900 p-3 rounded-2xl w-1/2"><p class="text-[9px] text-yellow-500 font-black uppercase">Servizio</p><p id="dir-orario" class="text-xl font-black text-white">--:--</p></div>
                </div>
                <div><p class="text-[9px] text-slate-500 font-black italic mb-3 uppercase">Ordine</p><div id="dir-bottiglie" class="space-y-2 text-sm italic font-bold"></div></div>
                <div class="pt-4 border-t border-slate-800"><p class="text-[9px] text-slate-500 font-black italic mb-1 uppercase">Note</p><p id="dir-note" class="text-xs text-white italic">Nessuna.</p></div>
            </div>
            <button onclick="document.getElementById('modal-direzione-dettagli').classList.add('hidden')" class="w-full mt-8 py-4 bg-white text-black font-black rounded-2xl text-[10px] uppercase italic">Esci</button>
        </div>
    </div>

    <div id="modal-mappa" class="hidden fixed inset-0 bg-black z-[4000] flex flex-col"><div class="p-5 flex justify-between bg-slate-950 items-center"><span class="text-yellow-500 font-black text-[10px] uppercase italic">Piantina HD</span><button onclick="toggleMappa(false)" class="bg-white text-black px-4 py-2 rounded-xl text-xs font-black uppercase italic">Esci</button></div><div class="flex-1 img-viewer"><img src="https://i.postimg.cc/8zqmMw4B/Image-6.jpg"></div></div>
    <div id="toast-container"></div>

    <script>
        // --- CONFIGURAZIONE E CONNESSIONE ---
        const SUPABASE_URL = "https://lktkmilzfcmcxpcqqvqo.supabase.co";
        const SUPABASE_KEY = "sb_publishable_O-4oxssSub-cwAvyXCyqzQ_5L9NdVZy"; 
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const bevande = [["Belvedere 0.7L", 150], ["Grey Goose 0.7L", 160], ["Mo√´t & Chandon", 130], ["Dom P√©rignon", 450], ["Gin Hendrick's", 140]];

        // STATO GLOBALE PREZZI (Default locale)
        let configLocale = { min_pista: 300, min_prive: 450, min_garden: 200, min_testa: 30 };

        let prenotazioni = [];
        let selectedTavolo = null;
        window.currentUser = "Ospite";
        window.userRole = "guest";
        let html5QrCode = null;

        // --- AUTH & INIT ---
        async function checkLogin() {
            const u = document.getElementById('user-input').value;
            const p = document.getElementById('pass-input').value;
            // Accesso Security
            if (u === 'security' && p === 'gate') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('nav-generale').classList.add('hidden');
                document.getElementById('nav-security').classList.remove('hidden');
                switchView('security');
                return;
            }
            // Accesso Utenti
            if(['cliente', 'pr123', 'boss'].includes(p)) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('landing-page').classList.remove('hidden');
                window.userRole = p === 'boss' ? 'boss' : (p === 'pr123' ? 'pr' : 'cliente');
                document.getElementById('btn-pr').classList.toggle('hidden', window.userRole !== 'pr');
                document.getElementById('btn-capo').classList.toggle('hidden', window.userRole !== 'boss');
                window.currentUser = u || "Ospite";
                await loadConfig(); // Scarica prezzi dal DB
                fetchPrenotazioni();
                showToast("Login effettuato", "üîì");
            } else { showToast("Password errata", "‚õî"); }
        }

        async function loadConfig() {
            const { data, error } = await client.from('impostazioni').select('*');
            if(data) {
                data.forEach(row => {
                    if(row.chiave === 'min_pista') configLocale.min_pista = row.valore;
                    if(row.chiave === 'min_prive') configLocale.min_prive = row.valore;
                    if(row.chiave === 'min_garden') configLocale.min_garden = row.valore;
                    if(row.chiave === 'min_testa') configLocale.min_testa = row.valore;
                });
                // Aggiorna Pannello Boss
                document.getElementById('input-min-pista').value = configLocale.min_pista;
                document.getElementById('input-min-prive').value = configLocale.min_prive;
                document.getElementById('input-min-garden').value = configLocale.min_garden;
                document.getElementById('input-min-testa').value = configLocale.min_testa;
                // Aggiorna Label Mappa
                document.getElementById('label-price-pista').innerText = `Base: ‚Ç¨${configLocale.min_pista}`;
                document.getElementById('label-price-prive').innerText = `Base: ‚Ç¨${configLocale.min_prive}`;
                document.getElementById('label-price-garden').innerText = `Base: ‚Ç¨${configLocale.min_garden}`;
            }
        }

        async function aggiornaListino() {
            const nPista = parseInt(document.getElementById('input-min-pista').value);
            const nPrive = parseInt(document.getElementById('input-min-prive').value);
            const nGarden = parseInt(document.getElementById('input-min-garden').value);
            const nTesta = parseInt(document.getElementById('input-min-testa').value);
            
            await client.from('impostazioni').update({ valore: nPista }).eq('chiave', 'min_pista');
            await client.from('impostazioni').update({ valore: nPrive }).eq('chiave', 'min_prive');
            await client.from('impostazioni').update({ valore: nGarden }).eq('chiave', 'min_garden');
            await client.from('impostazioni').update({ valore: nTesta }).eq('chiave', 'min_testa');
            
            showToast("Listino Aggiornato!", "üíæ");
            loadConfig();
        }

        async function fetchPrenotazioni() {
            const { data, error } = await client.from('prenotazioni').select('*');
            if (!error) { prenotazioni = data || []; aggiornaInterfacce(); aggiornaClassifica(); aggiornaMappaVisiva(); }
        }

        function aggiornaMappaVisiva() {
            document.querySelectorAll('.tavolo').forEach(el => el.classList.remove('tavolo-prenotato'));
            prenotazioni.forEach(p => { const el = document.getElementById(`map-tavolo-${p.tavolo_id}`); if (el) el.classList.add('tavolo-prenotato'); });
        }

        // --- CORE: MOTORE PRENOTAZIONE ---
        function selectTavolo(id, typeKey, zona) {
            if(document.getElementById(`map-tavolo-${id}`).classList.contains('tavolo-prenotato')) return showToast("Tavolo Occupato", "üîí");
            
            const realBasePrice = configLocale[typeKey]; 
            const realMinHead = configLocale.min_testa;

            selectedTavolo = { 
                tavolo_id: id, 
                min_table: realBasePrice, 
                zona, 
                persone: 5, 
                budget_head: realMinHead,
                totale: realBasePrice
            };
            
            // Reset UI
            document.getElementById('slider-persone').value = 5;
            document.getElementById('slider-budget').min = realMinHead;
            document.getElementById('slider-budget').value = realMinHead;
            
            document.getElementById('modal-pagamento').classList.remove('hidden');
            document.getElementById('pay-step-calc').classList.remove('hidden');
            document.getElementById('pay-step-checkout').classList.add('hidden');
            document.getElementById('pay-step-loading').classList.add('hidden');
            
            updatePriceCalculation();
        }

        function updatePriceCalculation() {
            const persone = parseInt(document.getElementById('slider-persone').value);
            const budgetHead = parseInt(document.getElementById('slider-budget').value);
            
            document.getElementById('warn-persone').classList.toggle('hidden', persone <= 20);

            // Algoritmo: Minimo Garantito
            const calcTotal = persone * budgetHead;
            const finalPrice = Math.max(selectedTavolo.min_table, calcTotal);

            document.getElementById('label-persone').innerText = persone;
            document.getElementById('label-budget').innerText = "‚Ç¨ " + budgetHead;
            document.getElementById('calc-total').innerText = "‚Ç¨ " + finalPrice;
            
            const note = document.getElementById('calc-note');
            if (calcTotal < selectedTavolo.min_table) {
                note.innerText = `‚ö†Ô∏è Applicato Minimale Tavolo (‚Ç¨${selectedTavolo.min_table})`;
                note.classList.replace('text-green-500', 'text-yellow-500');
            } else {
                note.innerText = `‚úÖ Budget Bottiglie: ‚Ç¨${finalPrice}`;
                note.classList.replace('text-yellow-500', 'text-green-500');
            }
            selectedTavolo.persone = persone;
            selectedTavolo.totale = finalPrice;
        }

        function goToCheckout() { document.getElementById('pay-step-calc').classList.add('hidden'); document.getElementById('pay-step-checkout').classList.remove('hidden'); }
        function backToCalc() { document.getElementById('pay-step-checkout').classList.add('hidden'); document.getElementById('pay-step-calc').classList.remove('hidden'); }

        async function processaPagamentoReale() {
            document.getElementById('pay-step-checkout').classList.add('hidden');
            document.getElementById('pay-step-loading').classList.remove('hidden');
            
            const prCode = document.getElementById('pr-input').value || "";
            let note = prCode ? "üéÅ PR: " + prCode : "";

            const { error } = await client.from('prenotazioni').insert([{
                tavolo_id: selectedTavolo.tavolo_id,
                zona: selectedTavolo.zona,
                prezzo: selectedTavolo.totale,
                cliente: window.currentUser,
                status: "Pagato",
                pr_ref: prCode,
                note: note,
                bottiglie: [],
                ingressi_totali: selectedTavolo.persone,
                ingressi_usati: 0
            }]);

            setTimeout(async () => {
                if(error) showToast("Errore DB: " + error.message, "‚ö†Ô∏è");
                else {
                    await fetchPrenotazioni();
                    document.getElementById('modal-pagamento').classList.add('hidden');
                    const newP = prenotazioni.find(p => p.tavolo_id === selectedTavolo.tavolo_id);
                    if(newP) { selectedTavolo = newP; mostraPassDigitale(); }
                }
            }, 2000);
        }

        function dividiConAmici() {
            if(navigator.share) {
                navigator.share({ title: 'NightHub Pay', text: `Ciao! Ecco la mia quota per il tavolo ${selectedTavolo.tavolo_id}.`, url: 'https://nighthub.it/pay' }).then(() => { showToast("Link inviato!", "üöÄ"); processaPagamentoReale(); }).catch(console.error);
            } else { showToast("Link copiato! Invialo su WhatsApp.", "üîó"); processaPagamentoReale(); }
        }

        // --- GESTIONE PASS & SECURITY ---
        function mostraPassDigitale() {
            document.getElementById('modal-pass').classList.remove('hidden');
            document.getElementById('pass-details').innerHTML = `<p class="text-white font-black text-xl uppercase">Tavolo ${selectedTavolo.tavolo_id}</p><p class="text-yellow-500 text-sm font-black italic mt-2">${selectedTavolo.cliente}</p>`;
            const rimasti = selectedTavolo.ingressi_totali - (selectedTavolo.ingressi_usati || 0);
            document.getElementById('pass-counter').innerHTML = `<div class="flex justify-between items-center"><div><p class="text-[9px] uppercase text-slate-400 font-bold">Ingressi Totali</p><p class="text-white font-black text-lg">${selectedTavolo.ingressi_usati || 0} / ${selectedTavolo.ingressi_totali}</p></div><div class="text-right"><p class="text-[9px] uppercase text-green-400 font-bold">Disponibili</p><p class="text-green-500 font-black text-2xl">${rimasti}</p></div></div>`;
            let qrData = `NIGHTHUB-T${selectedTavolo.tavolo_id}-${selectedTavolo.cliente}`;
            document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
        }
        function recuperaPass(idx) { selectedTavolo = prenotazioni[idx]; mostraPassDigitale(); }
        function chiudiPass() { document.getElementById('modal-pass').classList.add('hidden'); switchView('prenotazioni'); }

        async function aggiungiOspite(idx) {
            const cost = configLocale.min_testa;
            if(!confirm(`Vuoi aggiungere 1 ospite al tavolo? \nCosto: ‚Ç¨${cost}`)) return;
            const p = prenotazioni[idx];
            showToast("Pagamento in corso...", "üí≥");
            setTimeout(async () => {
                const { error } = await client.from('prenotazioni').update({ ingressi_totali: p.ingressi_totali + 1, prezzo: p.prezzo + cost }).eq('id', p.id);
                if(!error) { showToast("Ospite Aggiunto!", "‚úÖ"); fetchPrenotazioni(); } else { showToast("Errore", "‚ö†Ô∏è"); }
            }, 1000);
        }

        function startScanner() {
            if(html5QrCode) return;
            document.getElementById('modal-scanner').classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess).catch(err => { html5QrCode.start({ facingMode: "user" }, config, onScanSuccess); });
        }
        function onScanSuccess(decodedText) { stopScanner(); document.getElementById('security-scan-input').value = decodedText; checkIn(); }
        function stopScanner() { if(html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; document.getElementById('modal-scanner').classList.add('hidden'); }).catch(err => console.log(err)); } else { document.getElementById('modal-scanner').classList.add('hidden'); } }

        async function checkIn() {
            const input = document.getElementById('security-scan-input').value.toUpperCase();
            const resDiv = document.getElementById('security-result');
            resDiv.classList.remove('hidden', 'status-ok', 'status-ko', 'border-green-500', 'border-red-500');
            
            if(!input.startsWith("NIGHTHUB-T")) { showToast("Codice non valido", "‚ö†Ô∏è"); return; }
            const tID = input.split("-")[1].replace("T", "");
            
            const { data, error } = await client.from('prenotazioni').select('*').eq('tavolo_id', tID).single();
            if(error || !data) {
                resDiv.classList.add('status-ko', 'border-red-500');
                resDiv.innerHTML = `<h2 class="text-3xl font-black mb-2">‚õî NON TROVATO</h2><p>Tavolo ${tID}</p>`;
                return;
            }
            const usati = data.ingressi_usati || 0;
            const totali = data.ingressi_totali || 1; 

            if (usati >= totali) {
                resDiv.classList.add('status-ko', 'border-red-500');
                resDiv.innerHTML = `<h2 class="text-3xl font-black mb-2">‚õî COMPLETO</h2><p class="text-xl font-bold">${usati} / ${totali} Entrati</p><p class="text-xs mt-2">Acquistare extra in app</p>`;
                if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            } else {
                const nuovoUsati = usati + 1;
                await client.from('prenotazioni').update({ ingressi_usati: nuovoUsati, status: 'Entrato' }).eq('id', data.id);
                resDiv.classList.add('status-ok', 'border-green-500');
                resDiv.innerHTML = `<h2 class="text-4xl font-black mb-1">‚úÖ ENTRA</h2><p class="text-xl font-bold uppercase">${data.cliente}</p><div class="mt-4 bg-black/20 p-3 rounded-xl"><p class="text-xs font-black uppercase mb-1">Conteggio Gruppo</p><p class="text-3xl font-black">${nuovoUsati} <span class="text-sm">su</span> ${totali}</p></div>`;
                if(navigator.vibrate) navigator.vibrate([50, 50]);
            }
        }

        // --- UTILS ---
        function logout() { location.reload(); }
        function entraNelLocale(n) { document.getElementById('landing-page').classList.add('hidden'); document.getElementById('app-content').classList.remove('hidden'); document.getElementById('titolo-locale').innerText = n; fetchPrenotazioni(); loadConfig(); }
        function tornaAllaHome() { document.getElementById('landing-page').classList.remove('hidden'); document.getElementById('app-content').classList.add('hidden'); }
        function toggleMappa(s) { document.getElementById('modal-mappa').classList.toggle('hidden', !s); }
        function switchView(m) { if(navigator.vibrate) navigator.vibrate(10); document.querySelectorAll('.tab-active').forEach(e => e.classList.remove('tab-active')); document.querySelectorAll('.sezione-contenuto').forEach(e => e.classList.remove('active')); if(m === 'security') document.getElementById('sezione-security').classList.add('active'); else { document.getElementById('btn-' + m).classList.add('tab-active'); document.getElementById('sezione-' + m).classList.add('active'); fetchPrenotazioni(); } }
        function checkPromo(input) { document.getElementById('pr-input').classList.toggle('border-green-500', input.value.length > 0); }
        function showToast(message, icon = "‚úÖ") { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'toast'; t.innerHTML = `<span><span class="toast-icon">${icon}</span>${message}</span>`; c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(20px)'; setTimeout(() => t.remove(), 300); }, 3000); }
        function aggiornaInterfacce() { const container = document.getElementById('lista-prenotazioni-attive'); container.innerHTML = ""; const registroDir = document.getElementById('registro-direzione'); registroDir.innerHTML = ""; const registroPR = document.getElementById('lista-vendite-pr'); registroPR.innerHTML = ""; let wallet = 0; const COMM = 0.10; let myTablesCount = 0; prenotazioni.forEach((p, i) => { let showInMyTables = (window.userRole === 'cliente' && p.cliente === window.currentUser) || (window.userRole === 'pr' && p.pr_ref === window.currentUser); if (showInMyTables) { myTablesCount++; container.innerHTML += `<div class="glass p-6 rounded-[2rem] border-yellow-500/30 mb-4"><div class="flex justify-between items-start mb-4"><div><p class="text-[10px] font-black text-yellow-500 uppercase italic">Stato: ${p.status}</p><h3 class="text-xl font-black text-white italic">Tavolo ${p.tavolo_id}</h3><p class="text-[10px] text-slate-400 font-bold mt-1">üë• ${p.ingressi_usati||0} / ${p.ingressi_totali} Entrati</p></div><div class="flex flex-col gap-2"><button onclick="recuperaPass(${i})" class="bg-slate-800 text-white border border-yellow-500/50 px-3 py-2 rounded-xl font-black text-[9px] uppercase italic">üé´ QR CODE</button><button onclick="aggiungiOspite(${i})" class="bg-green-600 text-white px-3 py-2 rounded-xl font-black text-[9px] uppercase italic shadow-lg flex items-center gap-1 justify-center">+ üë§ ADD</button></div></div><button onclick="apriConfig(${i})" class="w-full ${p.status === "Inviato" ? "bg-green-500 text-black" : "bg-yellow-500 text-black"} text-[9px] font-black px-4 py-3 rounded-xl uppercase italic shadow-lg">${p.status === "Inviato" ? "Ordine Inviato ‚úì" : "Ordina Bottiglie"}</button></div>`; } let prLabel = p.pr_ref ? `<span class="text-yellow-500 text-[9px]"> (PR: ${p.pr_ref})</span>` : ""; registroDir.innerHTML += `<div onclick="apriDettagliDirezione(${i})" class="flex justify-between items-center p-4 bg-slate-950 rounded-2xl border border-slate-800 cursor-pointer active:scale-95 transition-transform"><div><p class="text-white text-[11px] font-black uppercase italic">${p.cliente}${prLabel}</p><p class="text-[9px] text-slate-500 uppercase font-black">T${p.tavolo_id} ‚Ä¢ üë• ${p.ingressi_usati||0}/${p.ingressi_totali}</p></div><span class="text-green-500 font-black text-[11px] italic">‚Ç¨ ${p.prezzo}</span></div>`; if (window.userRole === 'pr' && p.pr_ref === window.currentUser) { let prov = p.prezzo * COMM; wallet += prov; registroPR.innerHTML += `<div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-800 flex justify-between items-center"><div><p class="text-[11px] font-black text-white italic uppercase">${p.cliente}</p><p class="text-[9px] text-slate-500 font-bold uppercase">T${p.tavolo_id}</p></div><p class="text-sm font-black text-white italic">‚Ç¨ ${prov.toFixed(2)}</p></div>`; } }); if (myTablesCount === 0) container.innerHTML = '<p class="text-[10px] text-slate-600 text-center py-20 italic font-black uppercase">Nessun tavolo.</p>'; document.getElementById('pr-wallet-total').innerText = "‚Ç¨ " + wallet.toFixed(2); }
        function apriConfig(idx) { selectedTavolo = prenotazioni[idx]; document.getElementById('modal-config').classList.remove('hidden'); document.getElementById('conf-nome').innerText = "Tavolo " + selectedTavolo.tavolo_id; selectedTavolo.budget_calc = selectedTavolo.prezzo; document.getElementById('conf-budget').innerText = "‚Ç¨ " + selectedTavolo.budget_calc; const list = document.getElementById('conf-lista-bottiglie'); list.innerHTML = ""; bevande.forEach(b => { list.innerHTML += `<div class="bg-slate-900/50 p-5 rounded-3xl flex justify-between items-center border border-slate-800"><div><p class="font-black text-sm uppercase text-white italic">${b[0]}</p><p class="text-xs text-yellow-500 font-bold">‚Ç¨ ${b[1]}</p></div><button onclick="ordina('${b[0]}', ${b[1]})" class="bg-white text-black px-5 py-2 rounded-xl font-black text-[9px] uppercase italic active:scale-95 transition-transform">Aggiungi</button></div>`; }); }
        function ordina(n, p) { if(selectedTavolo.budget_calc >= p) { selectedTavolo.budget_calc -= p; if(!selectedTavolo.bottiglie) selectedTavolo.bottiglie = []; selectedTavolo.bottiglie.push(n); document.getElementById('conf-budget').innerText = "‚Ç¨ " + selectedTavolo.budget_calc; } else { showToast("Budget esaurito!", "‚ö†Ô∏è"); } }
        async function inviaOrdineFinale() { if(!selectedTavolo.orario) return showToast("Seleziona orario!", "‚è∞"); selectedTavolo.note = document.getElementById('note-ordine').value; const { error } = await client.from('prenotazioni').update({ status: "Inviato", orario: selectedTavolo.orario, note: selectedTavolo.note, bottiglie: selectedTavolo.bottiglie }).eq('id', selectedTavolo.id); if(!error) { showToast("Ordine Inviato!", "üöÄ"); document.getElementById('modal-config').classList.add('hidden'); fetchPrenotazioni(); } }
        function apriDettagliDirezione(idx) { const p = prenotazioni[idx]; document.getElementById('modal-direzione-dettagli').classList.remove('hidden'); document.getElementById('dir-titolo').innerText = "Tavolo " + p.tavolo_id; document.getElementById('dir-orario').innerText = p.orario || "--:--"; document.getElementById('dir-ingressi').innerText = `${p.ingressi_usati||0} / ${p.ingressi_totali}`; document.getElementById('dir-note').innerText = p.note || "Nessuna."; const list = document.getElementById('dir-bottiglie'); list.innerHTML = (p.bottiglie && p.bottiglie.length > 0) ? p.bottiglie.map(b => `<p>‚Ä¢ ${b}</p>`).join('') : "<p class='text-slate-600'>Nessun ordine.</p>"; }
        function setOrario(t, b) { selectedTavolo.orario = t; document.querySelectorAll('.orario-btn').forEach(btn => { btn.classList.replace('bg-yellow-500', 'bg-slate-800'); btn.classList.replace('text-black', 'text-slate-400'); }); b.classList.replace('bg-slate-800', 'bg-yellow-500'); b.classList.replace('text-slate-400', 'text-black'); }
        function richiediAccredito() { window.open(`https://wa.me/393331234567?text=Saldo: ${document.getElementById('pr-wallet-total').innerText}`, '_blank'); }
        function copiaLink() { navigator.clipboard.writeText("nighthub.it/ref/" + window.currentUser); showToast("Link Copiato!", "üîó"); }
        function aggiornaClassifica() { let stats = {}; const COMM = 0.10; prenotazioni.forEach(p => { let name = (p.pr_ref || "").trim().toUpperCase(); if(name) { if(!stats[name]) stats[name] = 0; stats[name] += (p.prezzo * COMM); } }); let sorted = Object.entries(stats).sort((a, b) => b[1] - a[1]); const div = document.getElementById('classifica-live'); div.innerHTML = ""; if(sorted.length === 0) { div.innerHTML = '<p class="text-[9px] text-slate-600 text-center py-4 italic">In attesa di dati...</p>'; return; } sorted.forEach((item, index) => { let rank = index + 1; let color = rank === 1 ? 'text-yellow-400' : 'text-white'; let icon = rank === 1 ? 'üëë ' : `${rank}. `; div.innerHTML += `<div class="flex justify-between items-center p-4 bg-slate-950 rounded-2xl border border-yellow-500/20"><span class="text-xs font-black italic ${color}">${icon}${item[0]}</span><span class="text-xs font-black text-yellow-500 italic">‚Ç¨ ${item[1].toFixed(2)}</span></div>`; }); }
    </script>
</body>
</html>
